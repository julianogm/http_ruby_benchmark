name: HTTP Ruby Benchmark

on:
  schedule:
    - cron: "0 0 */14 * *"

  workflow_dispatch:

jobs:
  benchmark:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        scenario: [light, normal, heavy]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: docker build -t benchmark-image .

      - name: Run benchmark (${{ matrix.scenario }})
        run: docker run --name benchmark-container-${{ matrix.scenario }} benchmark-image ruby benchmark.rb ${{ matrix.scenario }}

      - name: Copy results from container
        run: |
          docker cp benchmark-container-${{ matrix.scenario }}:/app/benchmark_latest_${{ matrix.scenario }}.json ./benchmark_latest_${{ matrix.scenario }}.json
          docker cp benchmark-container-${{ matrix.scenario }}:/app/benchmark_latest_${{ matrix.scenario }}.csv ./benchmark_latest_${{ matrix.scenario }}.csv
          echo "Files copied for scenario: ${{ matrix.scenario }}"
          ls -lh benchmark_latest_${{ matrix.scenario }}.*

      - name: Copy backward compatibility files (normal scenario)
        if: matrix.scenario == 'normal'
        run: |
          docker cp benchmark-container-${{ matrix.scenario }}:/app/benchmark_latest.json ./benchmark_latest.json
          docker cp benchmark-container-${{ matrix.scenario }}:/app/benchmark_latest.csv ./benchmark_latest.csv
          echo "Backward compatibility files copied"

      - name: Create results artifact
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results-${{ matrix.scenario }}
          path: |
            benchmark_latest_${{ matrix.scenario }}.json
            benchmark_latest_${{ matrix.scenario }}.csv
            benchmark_results_${{ matrix.scenario }}_*.json
            benchmark_results_${{ matrix.scenario }}_*.csv
          retention-days: 90

  commit-results:
    needs: benchmark
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: Consolidate results
        run: |
          mkdir -p results
          find ./artifacts -name "*.json" -o -name "*.csv" | xargs -I {} cp {} results/
          ls -lh results/

      - name: Remove temporary scenario files (no longer needed)
        run: |
          rm -f benchmark_latest*.json benchmark_latest*.csv || true
          echo "Removed temporary files"

      - name: Run consolidation script
        run: |
          ruby consolidate_results.rb
          echo "---"
          ls -lh benchmark_results.*
          echo "---"
          ls -lh README.md

      - name: Checkout original README (to preserve manual edits)
        run: |
          git checkout HEAD -- README.md || true
          echo "Original README restored"

      - name: Check if files changed
        id: check_changes
        run: |
          if git diff --quiet README.md benchmark_results.* 2>/dev/null; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push updated results
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          echo "Files to commit:"
          ls -lh benchmark_results.* README.md
          git add README.md benchmark_results.*
          git status
          git commit -m "chore: update benchmark results for all scenarios [skip ci]"
          git push

